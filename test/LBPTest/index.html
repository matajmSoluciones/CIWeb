<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Prueba JVision</title>
	<link rel="stylesheet" href="">
</head>
<body>
	<h1>Prueba Consola</h1>	
	<script src="Morphology.js" type="text/javascript"></script>	
	<script src="geometry.js" type="text/javascript"></script>	
	<script src="TurboColors.js" type="text/javascript"></script>	
	<script src="JSVisionLib.js" type="text/javascript"></script>
	<script>
		window.addEventListener("load",function(){
		var img=new Image();
		img.onload=function(e){
			var real=new Image();
			var lienzo=document.createElement("canvas");
			lienzo.width=img.naturalWidth;
			lienzo.height=img.naturalHeight;
			var context=lienzo.getContext("2d");
			context.drawImage(img,0,0,lienzo.width,lienzo.height);
			var template=context.getImageData(0,0,lienzo.width,lienzo.height);
			document.body.appendChild(lienzo);
			real.onload=function(){
				var lienzo2=document.createElement("canvas");
				lienzo2.width=lienzo.width;
				lienzo2.height=lienzo.height;
				var context2=lienzo2.getContext("2d");
				context2.drawImage(real,0,0,lienzo2.width,lienzo2.height);
				document.body.appendChild(lienzo2);
				var data=context2.getImageData(0,0,lienzo2.width,lienzo2.height);
				var LBP=JSVision.Feacture.LBP(data,0);
				fetch('templates/template.txt').then(function(data){
					return data.text();
				}).then(function(txt){
					var testValue=new Float32Array(txt.split(" ").slice(1,(LBP[0].data.length/4)+1));
					for(var i=0,j=0,n=LBP[0].length;i<n;i+=4,j=i/4){
						if(LBP[0].data[i]!=template.data[j]){
							throw new Error("La prueba ha fallado el LBP generado y la plantilla no coinciden en el indice "+i+"...",[LBP[0].data[i],template.data[i]]);
						}
					}
					fetch('templates/histogram.txt').then(function(data){
						return data.text();
					}).then(function(txt){
						var testValue=new Float32Array(txt.split(" ").slice(1,257));
						var hist=Histograms(LBP[0].data,"GRAY");						
						for(var i=0,n=testValue.length;i<n;i++){
							if(hist[i]!=testValue[i]){
								throw new Error("La prueba ha fallado el histograma y la plantilla no coinciden en el indice "+i+"...",[LBP[0].data[i],template.data[i]]);
							}
						}
						fetch('templates/histogramNormalized.txt').then(function(data){
							return data.text();
						}).then(function(txt){
							var testValue=new Float32Array(txt.split(" ").slice(1,257));							
							hist.Normalize();
							for(var i=0,n=testValue.length;i<n;i++){							
								if(Math.abs(hist[i]-testValue[i])>=0.01){
									throw new Error("La prueba ha fallado el histograma normalizado y la plantilla no coinciden en el indice "+i+"...",[LBP[0].data[i],template.data[i]]);
								}
							}
						context2.putImageData(LBP[0],0,0);
						console.log("El testeo ha finalizado exitosamente...");
						});
						
					});					
				});
			}
			real.src='templates/realTest.png';			
		}
		img.src='templates/LBPTest.jpeg';

		});
	</script>
</body>
</html>